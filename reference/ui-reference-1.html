import React, { useState, useEffect } from 'react';
import {
  Camera,
  Smartphone,
  CheckCircle2,
  X,
  Clock,
  Bell,
  ChevronRight,
  Settings,
  Moon,
  Sun,
  Scan
} from 'lucide-react';

export default function ToothbrushApp() {
  const [hasBrushed, setHasBrushed] = useState(false);
  const [streak, setStreak] = useState(12);
  const [view, setView] = useState('dashboard'); // dashboard, camera, nfc
  const [alarmActive, setAlarmActive] = useState(false);
  const [isSnoozed, setIsSnoozed] = useState(false);
  const [currentTime, setCurrentTime] = useState(new Date());

  // Update clock
  useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  const handleVerify = (method) => {
    if (method === 'manual') {
      completeBrushing();
    } else {
      setView(method);
    }
  };

  const completeBrushing = () => {
    setHasBrushed(true);
    setStreak(s => s + 1);
    setView('dashboard');
    setAlarmActive(false);
  };

  const triggerAlarm = () => {
    setAlarmActive(true);
    setIsSnoozed(false);
  };

  const handleSnooze = () => {
    setAlarmActive(false);
    setIsSnoozed(true);
    // In a real app, this would set a timeout to trigger again in 5 mins
  };

  // --- Components ---

  const Button = ({ children, onClick, variant = 'primary', className = '', icon: Icon }) => {
    const baseStyle = "flex items-center justify-center px-4 py-3 rounded-lg font-medium transition-all active:scale-95 text-sm";
    const variants = {
      primary: "bg-slate-900 text-white hover:bg-slate-800 shadow-sm",
      secondary: "bg-slate-100 text-slate-900 hover:bg-slate-200 border border-slate-200",
      outline: "border-2 border-slate-200 text-slate-700 hover:border-slate-300 hover:bg-slate-50",
      ghost: "text-slate-500 hover:text-slate-900 hover:bg-slate-100",
      destructive: "bg-red-500 text-white hover:bg-red-600",
    };

    return (
      <button
        onClick={onClick}
        className={`${baseStyle} ${variants[variant]} ${className}`}
      >
        {Icon && <Icon className="w-4 h-4 mr-2" />}
        {children}
      </button>
    );
  };

  const Card = ({ children, className = '' }) => (
    <div className={`bg-white rounded-xl border border-slate-200 shadow-sm ${className}`}>
      {children}
    </div>
  );

  // --- Views ---

  const Dashboard = () => (
    <div className="space-y-6 animate-in fade-in duration-500">
      {/* Header / Status */}
      <div className="text-center space-y-2 py-8">
        <div className={`inline-flex items-center justify-center w-24 h-24 rounded-full mb-4 transition-colors duration-500 ${hasBrushed ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-400'}`}>
          {hasBrushed ? <CheckCircle2 size={48} /> : <Moon size={48} />}
        </div>
        <h1 className="text-2xl font-bold tracking-tight text-slate-900">
          {hasBrushed ? "All clean!" : "Good evening, Alex"}
        </h1>
        <p className="text-slate-500">
          {hasBrushed
            ? "Sweet dreams and pearly whites."
            : "You haven't brushed your teeth yet today."}
        </p>
      </div>

      {/* Streak Card */}
      <Card className="p-4 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-orange-100 text-orange-600 rounded-md">
            <Sun size={20} />
          </div>
          <div>
            <p className="text-sm font-medium text-slate-900">Current Streak</p>
            <p className="text-xs text-slate-500">Keep it up!</p>
          </div>
        </div>
        <div className="text-2xl font-bold text-slate-900">{streak} <span className="text-sm font-normal text-slate-400">days</span></div>
      </Card>

      {/* Verification Methods (Only show if not brushed) */}
      {!hasBrushed && (
        <div className="grid gap-3">
          <p className="text-xs font-semibold uppercase tracking-wider text-slate-400 ml-1">Verify Brushing</p>

          <Button variant="outline" icon={Camera} onClick={() => handleVerify('camera')} className="justify-start h-14">
            Take a Selfie
          </Button>

          <Button variant="outline" icon={Scan} onClick={() => handleVerify('nfc')} className="justify-start h-14">
            Scan NFC Tag
          </Button>

          <Button variant="ghost" onClick={() => handleVerify('manual')} className="text-xs mt-2">
            I don't have my phone (Manual Confirm)
          </Button>
        </div>
      )}

      {/* Settings Preview */}
      <Card className="p-4 mt-8">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2 text-slate-700">
            <Clock size={16} />
            <span className="text-sm font-medium">Routine Alarm</span>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-sm text-slate-500">11:00 PM</span>
            <ChevronRight size={16} className="text-slate-300" />
          </div>
        </div>
      </Card>

      {/* Debugger */}
      <div className="pt-10 flex justify-center">
        <button
          onClick={triggerAlarm}
          className="text-[10px] text-slate-300 border border-slate-200 px-2 py-1 rounded hover:bg-slate-50 hover:text-slate-400 transition-colors"
        >
          DEBUG: TRIGGER 11PM ALARM
        </button>
      </div>
    </div>
  );

  const CameraView = () => (
    <div className="flex flex-col h-full animate-in zoom-in-95 duration-300">
      <div className="flex-1 bg-slate-900 rounded-2xl relative overflow-hidden flex flex-col items-center justify-center">
        {/* Mock Camera UI */}
        <div className="absolute top-4 right-4 text-white/50"><Settings size={20} /></div>
        <div className="w-48 h-64 border-2 border-white/20 rounded-xl flex items-center justify-center">
          <p className="text-white/40 text-sm text-center px-4">Align your toothbrush in frame</p>
        </div>

        {/* Camera Controls */}
        <div className="absolute bottom-0 left-0 right-0 p-8 bg-gradient-to-t from-black/80 to-transparent flex justify-between items-center">
          <button onClick={() => setView('dashboard')} className="p-3 rounded-full bg-white/10 text-white hover:bg-white/20">
            <X size={24} />
          </button>
          <button
            onClick={completeBrushing}
            className="w-16 h-16 rounded-full border-4 border-white flex items-center justify-center bg-white/20 hover:bg-white transition-all"
          >
            <div className="w-14 h-14 bg-white rounded-full" />
          </button>
          <div className="w-12" /> {/* Spacer for centering */}
        </div>
      </div>
    </div>
  );

  const NFCView = () => {
    // Simulate scan after 3 seconds
    useEffect(() => {
      const timer = setTimeout(() => {
        completeBrushing();
      }, 3000);
      return () => clearTimeout(timer);
    }, []);

    return (
      <div className="flex flex-col h-full items-center justify-center animate-in fade-in duration-500 relative overflow-hidden">
        <div className="absolute inset-0 bg-slate-50 -z-10" />

        {/* Ripple Animation */}
        <div className="relative flex items-center justify-center">
          <div className="absolute w-64 h-64 bg-blue-100 rounded-full animate-ping opacity-20" />
          <div className="absolute w-48 h-48 bg-blue-200 rounded-full animate-ping delay-75 opacity-20" />
          <div className="w-32 h-32 bg-white rounded-full shadow-xl flex items-center justify-center z-10">
            <Smartphone size={48} className="text-blue-500 animate-pulse" />
          </div>
        </div>

        <h2 className="mt-8 text-xl font-bold text-slate-900">Ready to Scan</h2>
        <p className="text-slate-500 mt-2 text-center max-w-xs">
          Hold your phone near the NFC tag on your bathroom mirror.
        </p>

        <Button variant="ghost" className="mt-12" onClick={() => setView('dashboard')}>
          Cancel
        </Button>
      </div>
    );
  };

  const AlarmOverlay = () => (
    <div className="fixed inset-0 z-50 bg-slate-900 flex flex-col items-center justify-between p-8 text-white animate-in slide-in-from-bottom duration-500">
      <div className="w-full flex justify-end">
        <Clock className="text-slate-500" />
      </div>

      <div className="flex flex-col items-center text-center space-y-6">
        <div className="w-24 h-24 bg-red-500 rounded-full flex items-center justify-center shadow-[0_0_40px_rgba(239,68,68,0.4)] animate-pulse">
          <Bell size={48} className="text-white" />
        </div>
        <div>
          <h1 className="text-4xl font-bold tracking-tight mb-2">11:00 PM</h1>
          <p className="text-xl text-slate-300 font-light">Time to brush your teeth!</p>
        </div>
      </div>

      <div className="w-full space-y-4 max-w-sm">
        <Button
          variant="primary"
          className="w-full h-14 bg-white text-slate-900 hover:bg-slate-100 font-bold text-lg"
          onClick={() => setAlarmActive(false)}
        >
          I'm Brushing Now
        </Button>
        <Button
          variant="ghost"
          className="w-full text-slate-400 hover:text-white hover:bg-white/10"
          onClick={handleSnooze}
        >
          Snooze for 10 min
        </Button>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 font-sans text-slate-900 selection:bg-slate-200">
      <div className="w-full max-w-md h-[800px] bg-white rounded-[32px] shadow-2xl border border-slate-200 overflow-hidden relative flex flex-col">

        {/* Status Bar Mock */}
        <div className="h-12 flex items-center justify-between px-6 border-b border-slate-50 shrink-0">
          <span className="text-xs font-semibold text-slate-900">
            {currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
          </span>
          <div className="flex gap-1.5">
            <div className="w-4 h-4 bg-slate-200 rounded-full" />
            <div className="w-4 h-4 bg-slate-200 rounded-full" />
            <div className="w-4 h-4 bg-slate-900 rounded-full" />
          </div>
        </div>

        {/* Main Content Area */}
        <div className="flex-1 p-6 overflow-y-auto relative">
          {view === 'dashboard' && <Dashboard />}
          {view === 'camera' && <CameraView />}
          {view === 'nfc' && <NFCView />}
        </div>

        {/* Alarm Overlay */}
        {alarmActive && <AlarmOverlay />}

        {/* Snooze Indicator (Toast) */}
        {isSnoozed && !alarmActive && !hasBrushed && (
          <div className="absolute bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-2 rounded-full text-xs font-medium shadow-lg animate-in slide-in-from-bottom-2 fade-in">
            Alarm snoozed until 11:10 PM
          </div>
        )}

      </div>
    </div>
  );
}
